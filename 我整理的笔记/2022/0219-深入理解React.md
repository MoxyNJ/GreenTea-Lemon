#  Fiber

> å¼•ç”¨ï¼š
>
> - https://juejin.cn/post/6844903975112671239#heading-4
> - https://juejin.cn/post/6844903582622285831#comment



Fiberçš„å¦å¤–ä¸€ç§è§£è¯»æ˜¯â€™çº¤ç»´â€˜: **è¿™æ˜¯ä¸€ç§æ•°æ®ç»“æ„æˆ–è€…è¯´æ‰§è¡Œå•å…ƒ**ã€‚æˆ‘ä»¬æš‚ä¸”ä¸ç®¡è¿™ä¸ªæ•°æ®ç»“æ„é•¿ä»€ä¹ˆæ ·ï¼Œ**ğŸ”´å°†å®ƒè§†ä½œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ª'æ‰§è¡Œå•å…ƒ', React å°±ä¼šæ£€æŸ¥ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´å°±å°†æ§åˆ¶æƒè®©å‡ºå»**ã€‚



ä¸Šæ–‡ä¸­æåˆ° React 16 ä¹‹å‰ï¼ŒReconcilation æ˜¯åŒæ­¥çš„ã€é€’å½’æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯åŸºäºå‡½æ•°â€™è°ƒç”¨æ ˆâ€˜çš„Reconcilationç®—æ³•ï¼Œå› æ­¤é€šå¸¸ä¹Ÿç§°å®ƒä¸º`Stack Reconcilation`. ä½ å¯ä»¥é€šè¿‡è¿™ç¯‡æ–‡ç« [ã€Šä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†ã€‹](https://juejin.cn/post/6844903861434449933) æ¥å›é¡¾ä¸€ä¸‹å†å²ã€‚



'`å‰¯ä½œç”¨`(Effect)' 

Reconcilation - è°ƒå’Œï¼Œv16ï¼ˆä¸å«ï¼‰ä»¥å‰çš„ç»å…¸ç®—æ³•ï¼Œç›¸å½“äº diffã€‚



DOM æ›´æ–°ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ‡åˆ†ä¸ºå¤šç»„ï¼ˆä¸€ç»„æœ‰nä¸ªfiberï¼‰å®Œæˆï¼›è¿™æ ·ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œä¸ä¼šäº§ç”Ÿè¿‡å¤šçš„å µå¡ã€‚



â€œæ¯ä¸ªå·¥ä½œå•å…ƒï¼ˆfiberï¼‰æ‰§è¡Œå®Œæˆåï¼Œéƒ½ä¼šæŸ¥çœ‹æ˜¯å¦è¿˜ç»§ç»­æ‹¥æœ‰ä¸»çº¿ç¨‹æ—¶é—´ç‰‡ï¼Œå¦‚æœæœ‰ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰åˆ™å…ˆå¤„ç†å…¶ä»–é«˜ä¼˜å…ˆçº§äº‹åŠ¡ï¼Œç­‰ä¸»çº¿ç¨‹ç©ºé—²ä¸‹æ¥ç»§ç»­æ‰§è¡Œã€‚â€è¿™é‡Œè²Œä¼¼æ²¡æœ‰è€ƒè™‘åˆ°ä»»åŠ¡è¿‡æœŸçš„æƒ…å†µï¼šå¦‚æœåœ¨ä¸€æ¬¡éå†æ—¶å‘ç°å¦‚æœæœ‰è¿‡æœŸä»»åŠ¡ï¼Œå› è¯¥ä¼šç«‹å³æ‰§è¡Œï¼Œå³ä½¿æ—¶é—´ç‰‡å·²ç»ç”¨å®Œã€‚















### useEffect

- useEffect çš„è§¦å‘æ—¶é—´æ˜¯åœ¨ render çš„æ‰§è¡Œä¹‹åï¼Œæ­¤æ—¶æ–°çš„ DOM å·²ç»æ„å»ºå®Œæˆï¼›
- useEffect æ˜¯å¼‚æ­¥è§¦å‘çš„ï¼Œä¸ä¼šå¯¹ js è¿›è¡Œé˜»å¡ã€‚
- æ‰€ä»¥ï¼Œåœ¨ useEffect å¯¹ state è¿›è¡Œæ›´æ–°ï¼Œå³ä½¿ä¸‹ä¾‹è¿™æ ·ï¼Œåªåœ¨åˆå§‹åŒ–ç»„ä»¶æ—¶æ›´æ–°ï¼ˆå³ useEffect çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ä¸º `[]`ï¼‰ï¼Œä¹Ÿä¼šå¯¼è‡´ç»„ä»¶å‘ç”Ÿä¸¤æ¬¡ DOM æ„å»ºï¼Œæ‰€ä»¥ `render dom` æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚

#### äº **useLayoutEffect**  çš„åŒºåˆ«

**useEffect** æ‰§è¡Œï¼Œ React å¤„ç†é€»è¾‘æ˜¯é‡‡ç”¨å¼‚æ­¥è°ƒç”¨ã€‚å¯¹äºæ¯ä¸€ä¸ª effect çš„ callbackï¼Œ React ä¼šå‘ `setTimeout` å›è°ƒå‡½æ•°ä¸€æ ·æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç­‰åˆ°ä¸»çº¿ç¨‹ä»»åŠ¡å®Œæˆï¼ŒDOM æ›´æ–°ï¼Œjs æ‰§è¡Œå®Œæˆï¼Œè§†å›¾ç»˜åˆ¶å®Œæ¯•ï¼Œæ‰æ‰§è¡Œã€‚æ‰€ä»¥ effect å›è°ƒå‡½æ•°ä¸ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶è§†å›¾ã€‚

**useLayoutEffect** çš„è§¦å‘æ—¶æœºæ˜¯åœ¨æ–°çš„ DOM ç»˜åˆ¶å‰ï¼Œæ‰€ä»¥æ–°çš„ DOM è™½ç„¶ä¹Ÿæ„å»ºå®Œæ¯•äº†ï¼ˆreturnä¸­çš„ä»£ç æ‰§è¡Œäº†ï¼‰ï¼Œä½†å°šæœªç»˜åˆ¶ï¼ŒèŠ‚çœäº†æµè§ˆå™¨çš„ç»˜åˆ¶æ€§èƒ½ã€‚

æ‰€ä»¥ï¼Œå¦‚æœæƒ³åœ¨ DOM ç»˜åˆ¶å‰ä¿®æ”¹ DOM å†…å®¹ï¼Œæ¯”å¦‚å¯¹ DOM ç»“æ„è¿›è¡Œä¿®æ”¹ã€æ›´æ–°ä¼šæ’å…¥ DOM ä¸­çš„ state æ•°æ®ç­‰ï¼Œç”¨ useLayoutEffect æ›´åˆé€‚ï¼Œå…¶ä½™æ—¶é—´éƒ½ç”¨ useEffect å³å¯ã€‚

- æ³¨æ„ï¼Œä¸¤ä¸ª hook éƒ½åœ¨æ–° DOM æ„å»ºå®Œæ¯•åå†æ‰§è¡Œ callbackï¼Œä¹Ÿå°±æ˜¯è¯´ return çš„ä»£ç éƒ½è¢«æ‰§è¡Œè¿‡äº†ã€‚

```jsx
function Container() {
  const [state, setState] = useState(0);

  useEffect(() => {
    console.log('useEffect', state)
    setState(10)
    },[]);

    return (
      <div>
      	{console.log('render dom', state)}
        <h3>React is kicking your ass for {state}th time...</h3>
      </div>
    )
}
```

![æˆªå±2022-02-18 ä¸‹åˆ8.34.35](æ·±å…¥ç†è§£React.assets/æˆªå±2022-02-18 ä¸‹åˆ8.35.20-5188560.png)

å¦‚æœä¸Šæ–‡ç›¸åŒçš„ä»£ç ç»“æ„ï¼Œåªæ˜¯æŠŠ useEffect æ›¿æ¢ä¸º useLayoutEffect çš„è¯ï¼š

![æˆªå±2022-02-18 ä¸‹åˆ8.51.47](æ·±å…¥ç†è§£React.assets/æˆªå±2022-02-18 ä¸‹åˆ8.51.47.png)







