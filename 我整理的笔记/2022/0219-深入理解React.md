#  Fiber

> å¼•ç”¨ï¼š
>
> - https://juejin.cn/post/6844903975112671239#heading-4
> - https://juejin.cn/post/6844903582622285831#comment
>
> Diff ç®—æ³•ï¼š
>
> - æ·±åº¦éå†ä¼˜å…ˆï¼ŒO(n)ï¼šhttps://juejin.cn/post/6967626390380216334







Fiberçš„å¦å¤–ä¸€ç§è§£è¯»æ˜¯â€™çº¤ç»´â€˜: **è¿™æ˜¯ä¸€ç§æ•°æ®ç»“æ„æˆ–è€…è¯´æ‰§è¡Œå•å…ƒ**ã€‚æˆ‘ä»¬æš‚ä¸”ä¸ç®¡è¿™ä¸ªæ•°æ®ç»“æ„é•¿ä»€ä¹ˆæ ·ï¼Œ**ğŸ”´å°†å®ƒè§†ä½œä¸€ä¸ªæ‰§è¡Œå•å…ƒï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ª'æ‰§è¡Œå•å…ƒ', React å°±ä¼šæ£€æŸ¥ç°åœ¨è¿˜å‰©å¤šå°‘æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰æ—¶é—´å°±å°†æ§åˆ¶æƒè®©å‡ºå»**ã€‚



ä¸Šæ–‡ä¸­æåˆ° React 16 ä¹‹å‰ï¼ŒReconcilation æ˜¯åŒæ­¥çš„ã€é€’å½’æ‰§è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´è¿™æ˜¯åŸºäºå‡½æ•°â€™è°ƒç”¨æ ˆâ€˜çš„Reconcilationç®—æ³•ï¼Œå› æ­¤é€šå¸¸ä¹Ÿç§°å®ƒä¸º`Stack Reconcilation`. ä½ å¯ä»¥é€šè¿‡è¿™ç¯‡æ–‡ç« [ã€Šä»Preactä¸­äº†è§£Reactç»„ä»¶å’ŒhooksåŸºæœ¬åŸç†ã€‹](https://juejin.cn/post/6844903861434449933) æ¥å›é¡¾ä¸€ä¸‹å†å²ã€‚



'`å‰¯ä½œç”¨`(Effect)' 

Reconcilation - è°ƒå’Œï¼Œv16ï¼ˆä¸å«ï¼‰ä»¥å‰çš„ç»å…¸ç®—æ³•ï¼Œç›¸å½“äº diffã€‚



DOM æ›´æ–°

DOM æ›´æ–°ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆçš„ï¼Œè€Œæ˜¯åˆ‡åˆ†ä¸ºå¤šç»„ï¼ˆä¸€ç»„æœ‰nä¸ªfiberï¼‰å®Œæˆï¼›è¿™æ ·ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼Œä¸ä¼šäº§ç”Ÿè¿‡å¤šçš„å µå¡ã€‚

åŒç¼“å†²
WIP æ ‘æ„å»ºè¿™ç§æŠ€æœ¯ç±»ä¼¼äºå›¾å½¢åŒ–é¢†åŸŸçš„'åŒç¼“å­˜(Double Buffering)'æŠ€æœ¯, å›¾å½¢ç»˜åˆ¶å¼•æ“ä¸€èˆ¬ä¼šä½¿ç”¨åŒç¼“å†²æŠ€æœ¯ï¼Œå…ˆå°†å›¾ç‰‡ç»˜åˆ¶åˆ°ä¸€ä¸ªç¼“å†²åŒºï¼Œå†ä¸€æ¬¡æ€§ä¼ é€’ç»™å±å¹•è¿›è¡Œæ˜¾ç¤ºï¼Œè¿™æ ·å¯ä»¥é˜²æ­¢å±å¹•æŠ–åŠ¨ï¼Œä¼˜åŒ–æ¸²æŸ“æ€§èƒ½ã€‚
æ”¾åˆ°React ä¸­ï¼ŒWIPæ ‘å°±æ˜¯ä¸€ä¸ªç¼“å†²ï¼Œå®ƒåœ¨Reconciliation å®Œæ¯•åä¸€æ¬¡æ€§æäº¤ç»™æµè§ˆå™¨è¿›è¡Œæ¸²æŸ“ã€‚å®ƒå¯ä»¥å‡å°‘å†…å­˜åˆ†é…å’Œåƒåœ¾å›æ”¶ï¼ŒWIP çš„èŠ‚ç‚¹ä¸å®Œå…¨æ˜¯æ–°çš„ï¼Œæ¯”å¦‚æŸé¢—å­æ ‘ä¸éœ€è¦å˜åŠ¨ï¼ŒReactä¼šå…‹éš†å¤ç”¨æ—§æ ‘ä¸­çš„å­æ ‘ã€‚

æ‰€ä»¥ï¼ŒDOM æ›´æ–°è™½ç„¶ä¸æ˜¯ä¸€æ¬¡æ€§å®Œæˆï¼Œä½†åªæœ‰åœ¨ä¸€ä¸ª DOM æ›´æ–°ä»»åŠ¡å…¨éƒ¨å®Œæˆåï¼Œæ‰ä¼šä¸€æ¬¡æ€§æ¸²æŸ“åˆ°é¡µé¢ä¸­ï¼Œé˜²æ­¢é¡µé¢å¤šæ¬¡æŠ–åŠ¨ã€‚



Git åŠŸèƒ½åˆ†æ”¯ï¼Œ**ä½ å¯ä»¥å°† WIP æ ‘æƒ³è±¡æˆä»æ—§æ ‘ä¸­ Fork å‡ºæ¥çš„åŠŸèƒ½åˆ†æ”¯ï¼Œä½ åœ¨è¿™æ–°åˆ†æ”¯ä¸­æ·»åŠ æˆ–ç§»é™¤ç‰¹æ€§ï¼Œå³ä½¿æ˜¯æ“ä½œå¤±è¯¯ä¹Ÿä¸ä¼šå½±å“æ—§çš„åˆ†æ”¯ã€‚å½“ä½ è¿™ä¸ªåˆ†æ”¯ç»è¿‡äº†æµ‹è¯•å’Œå®Œå–„ï¼Œå°±å¯ä»¥åˆå¹¶åˆ°æ—§åˆ†æ”¯ï¼Œå°†å…¶æ›¿æ¢æ‰. è¿™æˆ–è®¸å°±æ˜¯â€™æäº¤(commit)é˜¶æ®µâ€˜çš„æäº¤ä¸€è¯çš„æ¥æºå§ï¼Ÿ**:





ä¸€å¸§16msï¼Œç„¶å16mså‡å»è¯¥å¸§ä½¿ç”¨çš„æ—¶é—´æ‰æ˜¯å‰©ä½™å¯ç”¨çš„ç©ºé—²æ—¶é—´ï¼Œæˆ‘ä¸å¤ªæ‡‚çš„æ˜¯ä¸€ä¸ªå¾…å¤„ç†çš„fiber node è¶…è¿‡è¿™ä¸ªç©ºé—²æ—¶é—´ï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œä¼šä¸ä¼šå»åˆ¤æ–­è¯¥å¸§çš„ç©ºé—²æ˜¯å¦èƒ½æ‰§è¡Œå®Œè¿™ä¸ªnodeï¼Œè¿˜æ˜¯åªè¦æœ‰ç©ºé—²æ—¶é—´å°±ä¼šæ‰§è¡Œè¿™ä¸ªä¼šé˜»å¡ä¸‹ä¸€å¸§çš„node ï¼Ÿ

- â€œæ¯ä¸ªå·¥ä½œå•å…ƒï¼ˆfiberï¼‰æ‰§è¡Œå®Œæˆåï¼Œéƒ½ä¼šæŸ¥çœ‹æ˜¯å¦è¿˜ç»§ç»­æ‹¥æœ‰ä¸»çº¿ç¨‹æ—¶é—´ç‰‡ï¼Œå¦‚æœæœ‰ç»§ç»­ä¸‹ä¸€ä¸ªï¼Œå¦‚æœæ²¡æœ‰åˆ™å…ˆå¤„ç†å…¶ä»–é«˜ä¼˜å…ˆçº§äº‹åŠ¡ï¼Œç­‰ä¸»çº¿ç¨‹ç©ºé—²ä¸‹æ¥ç»§ç»­æ‰§è¡Œã€‚â€è¿™é‡Œè²Œä¼¼æ²¡æœ‰è€ƒè™‘åˆ°ä»»åŠ¡è¿‡æœŸçš„æƒ…å†µï¼šå¦‚æœåœ¨ä¸€æ¬¡éå†æ—¶å‘ç°å¦‚æœæœ‰è¿‡æœŸä»»åŠ¡ï¼Œå› è¯¥ä¼šç«‹å³æ‰§è¡Œï¼Œå³ä½¿æ—¶é—´ç‰‡å·²ç»ç”¨å®Œã€‚
- æ˜¯ä¼šé˜»å¡çš„ï¼Œæµè§ˆå™¨æ˜¯æ²¡æƒé˜»æ­¢ä½ åœ¨requestIdleCallbackçš„å›è°ƒé‡Œå¤„ç†ä¸€ä¸ªè¶…é•¿ä»»åŠ¡çš„ï¼Œæ¯•ç«Ÿjså¼•æ“å§‹ç»ˆæ˜¯å•çº¿ç¨‹çš„ã€‚
- å¯ä»¥è‚¯å®šçš„æ˜¯ï¼Œreactä¼šå¯¹æ¯ä¸ªä»»åŠ¡ç»´æŒä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œå¦‚æœå·²ç»è¿‡æœŸï¼Œåˆ™åœ¨æ­¤æ—¶ä¸ä¼šå»è€ƒè™‘æ˜¯å¦å‡ºç°æ‰å¸§çš„æƒ…å†µï¼ˆå³æ—¶é—´ç‰‡æ˜¯å¦ç”¨å®Œçš„æƒ…å†µï¼‰ï¼Œè€Œé€‰æ‹©ç«‹å³æ‰§è¡Œã€‚



å¤§ä½¬ï¼Œæ‚¨æ‰çœ‹æˆ‘æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£ï¼š

- åœ¨react16ä¹‹å‰setStateè§¦å‘è§†å›¾æ›´æ–°æ˜¯ä»å¾…æ›´æ–°ç»„ä»¶å¼€å§‹é€å±‚é€’å½’æ›´æ–°ã€‚å¦‚æœæ›´æ–°æ—¶é—´è¿‡ç¨‹è¶…è¿‡äº†æµè§ˆå™¨ä¸€å¸§çš„æ—¶é—´å°±ä¼šé€ æˆå¡é¡¿çš„ç°è±¡ã€‚ 

- æ‰€ä»¥åœ¨react16ä»¥åå°†æ¯ä¸€ä¸ªè™šæ‹ŸdomèŠ‚ç‚¹éƒ½ç”¨fiberæ¥å®ç°ï¼Œæ‰€æœ‰çš„æ‰§è¡Œå•å…ƒé€šè¿‡é“¾è¡¨çš„ç»“æ„æ¥ç»´æŠ¤ã€‚ä»è€Œå®ç°éå†èŠ‚ç‚¹æ—¶çš„æš‚åœæ¢å¤ã€‚ åœ¨setStateè§¦å‘æ›´æ–°ååˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µåˆ†åˆ«æ˜¯ **åè°ƒ** å’Œ **æäº¤**ã€‚
  - åœ¨ **åè°ƒé˜¶æ®µ** åˆ©ç”¨æµè§ˆå™¨æ¯ä¸€å¸§å¤„ç†äº‹ä»¶åçš„å‰©ä½™æ—¶é—´è¿›è¡Œè®¡ç®—ï¼Œå¦‚æœæ—¶é—´ä¸å¤Ÿåˆ™ä¸‹ä¸€å¸§å†å¤„ç†ã€‚ä»¥æ­¤æ¥è®¡ç®—å‡ºå“ªäº›èŠ‚ç‚¹äº§ç”Ÿäº†å‰¯ä½œç”¨æ˜¯éœ€è¦å¤„ç†çš„ã€‚æœ€åå† **æäº¤é˜¶æ®µ** ç»Ÿä¸€å¤„ç†ã€‚





é—®é¢˜ï¼šreact å‡½æ•°ç»„ä»¶é‡æ–°æ¸²æŸ“éƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œå‡½æ•°å†…åˆ°å˜é‡ã€æ•°æ®éƒ½ä¼šé‡æ–°è¢«åˆ›å»ºï¼Œé‚£ state å€¼å¦‚ä½•èƒ½ä¸€ç›´ä¿å­˜ä¸‹æ¥å‘¢ï¼Ÿ

ç²¾ç®€ç­”æ¡ˆï¼šfiber ä¸­æœ‰ä¸€ä¸ª memorizedState ä¸€ç›´æŒæœ‰å¯¹ç»„ä»¶å†… state çš„å¼•ç”¨ï¼›æ‰€ä»¥åˆ©ç”¨é—­åŒ…å¯ä»¥å®ç° state å€¼ä¼šä¸¢å¤±çš„é—®é¢˜ã€‚

> - https://blog.matthew-wang.com/react-hooks-learning-notes-2/
>
> Hooks ä¿å­˜ stateï¼Ÿ
> é‚£æ—¢ç„¶éƒ½è¯´äº†å‡½æ•°ç»„ä»¶æ¯æ¬¡é‡æ–°æ¸²æŸ“çš„æ—¶å€™å†…éƒ¨æ‰€æœ‰ä¸œè¥¿éƒ½æ˜¯å…¨æ–°çš„ï¼Œhooks åˆæ€ä¹ˆèƒ½å¤Ÿå®ç°ä¿å­˜ state çš„é€»è¾‘å‘¢ï¼ŸåŸç†å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨å‡½æ•°å¤–é¢å®šä¹‰äº†ä¸€ä¸ªå˜é‡ï¼Œå‡½æ•°é‡Œé¢è¯»å–äº†è¿™ä¸ªå˜é‡ï¼Œç”šè‡³ç»™è¿™ä¸ªå˜é‡é‡æ–°èµ‹å€¼ï¼Œéƒ½ä¼šçœŸå®åæ˜ åœ¨å¤–éƒ¨çš„è¿™ä¸ªå˜é‡èº«ä¸Šï¼Œå³ä½¿å‡½æ•°æ‰§è¡Œå®Œæˆè¢«é”€æ¯ï¼Œå…¶å¯¹è¯¥å˜é‡çš„æ“ä½œä¹Ÿä¸ä¼šä¸¢å¤±ã€‚é‚£å¦‚æœæˆ‘å†æ¬¡æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå®ƒè¯»å–åˆ°çš„è¿™ä¸ªå˜é‡å°±å°†ä¼šæ˜¯ç»è¿‡å®ƒé€»è¾‘ä¿®æ”¹è¿‡ä¸€ä¸ªçš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå˜é‡åªä¼šè¢«è¿™ä¸ªå‡½æ•°è¯»å–å’Œæ”¹å˜çš„è¯ï¼Œé‚£ä»æŸç§æ„ä¹‰ä¸Šï¼Œæˆ‘ä»¬æ˜¯å¦èƒ½è¯´è¿™ä¸ªå˜é‡ä¿å­˜äº†è¿™ä¸ªå‡½æ•°æ¯æ¬¡æ‰§è¡Œæ—¶çš„ state å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè€Œ hooks ä¹Ÿç¡®å®æ˜¯è¿™æ ·åšçš„ï¼Œæ¯æ¬¡ä½ ä½¿ç”¨ hooksï¼Œå…¶å¯¹åº”çš„ stateã€function éƒ½è¢«ä¿å­˜åœ¨å½“å‰ fiber çš„ memorizedState å±æ€§ä¸Šï¼Œè€Œ fiber åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“çš„æ—¶å€™éƒ½ä¼šä¾æ®æŸç§é€»è¾‘ï¼ˆfiber çš„å…·ä½“é€»è¾‘å’Œæœ¬æ–‡è¦è¯´çš„éƒ¨åˆ†æ— å…³ï¼‰ç»§æ‰¿ä¹‹å‰çš„å±æ€§ï¼Œé€šè¿‡è¿™æ ·çš„ä¸€ä¸ªé€»è¾‘ï¼Œå°±è¾¾åˆ°äº†ä¿å­˜ state çš„æ•ˆæœã€‚





























=======================================================================================

### useEffect

- useEffect çš„è§¦å‘æ—¶é—´æ˜¯åœ¨ render çš„æ‰§è¡Œä¹‹åï¼Œæ­¤æ—¶æ–°çš„ DOM å·²ç»æ„å»ºå®Œæˆï¼›
- useEffect æ˜¯å¼‚æ­¥è§¦å‘çš„ï¼Œä¸ä¼šå¯¹ js è¿›è¡Œé˜»å¡ã€‚
- æ‰€ä»¥ï¼Œåœ¨ useEffect å¯¹ state è¿›è¡Œæ›´æ–°ï¼Œå³ä½¿ä¸‹ä¾‹è¿™æ ·ï¼Œåªåœ¨åˆå§‹åŒ–ç»„ä»¶æ—¶æ›´æ–°ï¼ˆå³ useEffect çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ä¸º `[]`ï¼‰ï¼Œä¹Ÿä¼šå¯¼è‡´ç»„ä»¶å‘ç”Ÿä¸¤æ¬¡ DOM æ„å»ºï¼Œæ‰€ä»¥ `render dom` æ‰§è¡Œäº†ä¸¤æ¬¡ã€‚

#### äº **useLayoutEffect**  çš„åŒºåˆ«

**useEffect** æ‰§è¡Œï¼Œ React å¤„ç†é€»è¾‘æ˜¯é‡‡ç”¨å¼‚æ­¥è°ƒç”¨ã€‚å¯¹äºæ¯ä¸€ä¸ª effect çš„ callbackï¼Œ React ä¼šå‘ `setTimeout` å›è°ƒå‡½æ•°ä¸€æ ·æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚ç­‰åˆ°ä¸»çº¿ç¨‹ä»»åŠ¡å®Œæˆï¼ŒDOM æ›´æ–°ï¼Œjs æ‰§è¡Œå®Œæˆï¼Œè§†å›¾ç»˜åˆ¶å®Œæ¯•ï¼Œæ‰æ‰§è¡Œã€‚æ‰€ä»¥ effect å›è°ƒå‡½æ•°ä¸ä¼šé˜»å¡æµè§ˆå™¨ç»˜åˆ¶è§†å›¾ã€‚

**useLayoutEffect** çš„è§¦å‘æ—¶æœºæ˜¯åœ¨æ–°çš„ DOM ç»˜åˆ¶å‰ï¼Œæ‰€ä»¥æ–°çš„ DOM è™½ç„¶ä¹Ÿæ„å»ºå®Œæ¯•äº†ï¼ˆreturnä¸­çš„ä»£ç æ‰§è¡Œäº†ï¼‰ï¼Œä½†å°šæœªç»˜åˆ¶ï¼ŒèŠ‚çœäº†æµè§ˆå™¨çš„ç»˜åˆ¶æ€§èƒ½ã€‚

æ‰€ä»¥ï¼Œå¦‚æœæƒ³åœ¨ DOM ç»˜åˆ¶å‰ä¿®æ”¹ DOM å†…å®¹ï¼Œæ¯”å¦‚å¯¹ DOM ç»“æ„è¿›è¡Œä¿®æ”¹ã€æ›´æ–°ä¼šæ’å…¥ DOM ä¸­çš„ state æ•°æ®ç­‰ï¼Œç”¨ useLayoutEffect æ›´åˆé€‚ï¼Œå…¶ä½™æ—¶é—´éƒ½ç”¨ useEffect å³å¯ã€‚

- æ³¨æ„ï¼Œä¸¤ä¸ª hook éƒ½åœ¨æ–° DOM æ„å»ºå®Œæ¯•åå†æ‰§è¡Œ callbackï¼Œä¹Ÿå°±æ˜¯è¯´ return çš„ä»£ç éƒ½è¢«æ‰§è¡Œè¿‡äº†ã€‚

```jsx
function Container() {
  const [state, setState] = useState(0);

  useEffect(() => {
    console.log('useEffect', state)
    setState(10)
    },[]);

    return (
      <div>
      	{console.log('render dom', state)}
        <h3>React is kicking your ass for {state}th time...</h3>
      </div>
    )
}
```

![æˆªå±2022-02-18 ä¸‹åˆ8.34.35](æ·±å…¥ç†è§£React.assets/æˆªå±2022-02-18 ä¸‹åˆ8.35.20-5188560.png)

å¦‚æœä¸Šæ–‡ç›¸åŒçš„ä»£ç ç»“æ„ï¼Œåªæ˜¯æŠŠ useEffect æ›¿æ¢ä¸º useLayoutEffect çš„è¯ï¼š

![æˆªå±2022-02-18 ä¸‹åˆ8.51.47](æ·±å…¥ç†è§£React.assets/æˆªå±2022-02-18 ä¸‹åˆ8.51.47.png)







