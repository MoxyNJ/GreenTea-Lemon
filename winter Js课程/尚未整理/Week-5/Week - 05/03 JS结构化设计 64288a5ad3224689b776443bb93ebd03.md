# 03. JSç»“æ„åŒ–è®¾è®¡

# JSæ‰§è¡Œç²’åº¦ï¼ˆè¿è¡Œæ—¶ï¼‰

- å®ä»»åŠ¡ï¼šä¼ ç»™JavaScriptå¼•æ“çš„ä»»åŠ¡
- å¾®ä»»åŠ¡ï¼ˆPromiseï¼‰ï¼šJavaScriptå†…éƒ¨çš„ä»»åŠ¡
- å‡½æ•°è°ƒç”¨ï¼ˆExecution Contextï¼‰
- è¯­å¥/å£°æ˜ï¼ˆCompletion Recordï¼‰
- è¡¨è¾¾å¼ï¼ˆReferenceï¼‰
- ç›´æ¥é‡/å˜é‡/this ...

# ä¸€ã€å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

---

MacroTaskï¼šå®ä»»åŠ¡

MicroTask (Job)ï¼šå¾®ä»»åŠ¡

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled.png)

åˆ©ç”¨Promiseï¼Œå½¢æˆäº†ä¸¤ä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œç„¶åæœ€ç»ˆè¾“å‡º `x = 3;` ã€‚è¿™ä¸€æ•´å¥—æµç¨‹ï¼Œå°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ã€‚

# äºŒã€æ—¶é—´å¾ªç¯

---

è·å–ä»£ç  â†’ æ‰§è¡Œä»£ç  â†’ ç­‰å¾…âŒ›ï¸(æ—¶é—´/äº‹ä»¶)ã€‚

- OCä¸­ï¼Œä¼šç­‰å¾…ä¸€ä¸ªé”ğŸ”’ï¼Œä¸åŒçš„æ¡ä»¶å»è§¦å‘é”ï¼Œç„¶åç»§ç»­è·å–ä»£ç ã€‚
- ç”¨æˆ·è¾“å…¥äº‹ä»¶ã€IOæ“ä½œäº‹ä»¶ç­‰ç­‰

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%201.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%201.png)

# ä¸‰ã€å‡½æ•°è°ƒç”¨

---

åŒä¸€ä¸ªå¾®ä»»åŠ¡ä¸­ï¼Œä¹Ÿä¸æ˜¯é¡ºåºæ‰§è¡Œï¼Œä¼šå—å‡½æ•°è°ƒç”¨å½±å“ã€‚

Execution Contextï¼šæ‰§è¡Œä¸Šä¸‹æ–‡ã€‚åœ¨æ‰§è¡Œä¸€ä¸ªè¯­å¥çš„æ—¶å€™ï¼Œæ‰€éœ€è¦çš„æ‰€æœ‰çš„ä¿¡æ¯ï¼Œéƒ½ä¿å­˜åœ¨è¿™ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ä¸­ã€‚

Execution Context Stackï¼šæ‰§è¡Œä¸Šä¸‹æ–‡æ ˆã€‚ä¿å­˜æ‰§è¡Œä¸Šä¸‹æ–‡çš„æ•°æ®ç»“æ„ã€‚

Running Execution Contextï¼šæ ˆé¡¶å…ƒç´ ã€‚æ­£åœ¨è¿è¡Œçš„ä»£ç å—ã€‚

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%202.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%202.png)

- code evaluation stateï¼šç”¨äºasyncå’Œgeneratorå‡½æ•°ï¼Œä¿å­˜ä»£ç æ‰§è¡Œåˆ°å“ªä¸€æ­¥ã€‚
- Functionï¼šä¿å­˜Functionåˆå§‹åŒ–çš„ä¿¡æ¯ã€‚
- Script or Moduleï¼šäºŒé€‰ä¸€ã€‚
- Generatorï¼šgeneratorå‡½æ•°éœ€è¦è¿™ä¸ªå­—æ®µã€‚
- Realmï¼šä¿å­˜æ‰€æœ‰ä½¿ç”¨çš„å†…ç½®å¯¹è±¡ã€‚
- LexicalEnvironmentï¼šæ‰§è¡Œä»£ç ä¸­æ‰€éœ€è¦è®¿é—®çš„ç¯å¢ƒï¼Œä¿å­˜å˜é‡ã€‚
- VariableEnvironmentï¼šå†³å®švarå£°æ˜å˜é‡ï¼Œä¼šå£°æ˜åˆ°å“ªä¸ªç¯å¢ƒã€‚

## LexicalEnvironment

- this
- new.target
- super
- å˜é‡

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%203.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%203.png)

## VariableEnvironment

æ˜¯ä¸€ä¸ªå†å²åŒ…è¢±ï¼Œåªç”¨æ¥å¤„ç†varå‡½æ•°å£°æ˜ã€‚

- `eval(`var x  = 1;`)` ä¼šæŠŠxå£°æ˜åˆ°æ›´å¤§çš„èŒƒå›´ã€‚
- `with({a:1}){ ... }` ä¼šå£°æ˜åˆ°æ›´å¤§èŒƒå›´ã€‚

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%204.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%204.png)

## Environment Record ç¯å¢ƒ

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%205.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%205.png)

ç»§æ‰¿å…³ç³»ã€‚

- Global Environment Recordsï¼šç‰¹æ®Šåœºæ™¯ï¼Œåªæœ‰ä¸€ä¸ªã€‚
- Object Environment Recordsï¼šç‰¹æ®Šåœºæ™¯ï¼Œç»™withä½¿ç”¨çš„ã€‚
- Declarative Environment Recordsï¼šä¸æ˜¯æŠ½è±¡ç±»ï¼Œå¯ä»¥åˆå§‹åŒ–ã€‚{èŠ±æ‹¬å·} çš„blockï¼Œæœ‰è‡ªå·±çš„ä½œç”¨åŸŸï¼Œåœ¨è¿è¡Œæ—¶ï¼Œå°±ä¼šç”ŸæˆDeclarative Environment Recordsã€‚
    - Function Environment Recordsï¼šå‡½æ•°ä¼šç”Ÿæˆè‡ªå·±çš„ä½œç”¨åŸŸã€‚
    - module Environment Recordsï¼šmoduleä¼šç”Ÿæˆè‡ªå·±çš„ä½œç”¨åŸŸã€‚

## å‡½æ•° - é—­åŒ…

åœ¨JSä¸­ï¼Œæ¯ä¸€ä¸ªå‡½æ•°åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆè‡ªå·±çš„ä¸€ä¸ªé—­åŒ…ã€‚

é—­åŒ…ï¼š

- ä»£ç éƒ¨åˆ†ï¼šå‡½æ•°çš„ä»£ç ã€‚
- ç¯å¢ƒéƒ¨åˆ†ï¼šç”±ä¸€ä¸ªObjectå’Œä¸€ä¸ªå˜é‡çš„åºåˆ—ç»„æˆã€‚

æ¯ä¸ªå‡½æ•°éƒ½ä¼šå¸¦ä¸€ä¸ªå®šä¹‰æ—¶ï¼Œåœ¨è‡ªå·±çš„å‡½æ•°å±æ€§ä¸­ï¼Œè®°å½•ä¸‹æ‰€åœ¨çš„Environment Recordå½“å‰ç¯å¢ƒã€‚

### ä¸¾ä¾‹1ï¼š

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%206.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%206.png)

- å¦‚æœfoo2å‡½æ•°ï¼Œåœ¨å½“å‰ç¯å¢ƒä¸­ï¼Œæœ‰ä¸€ä¸ªå˜é‡ï¼š`y = 2;` é‚£ä¹ˆï¼Œä¸ç®¡å°†æ¥é€šè¿‡å‚æ•°ã€exportã€importä¼ åˆ°ä»»ä½•åœ°æ–¹ï¼Œéƒ½ä¼šå¸¦ä¸Šè¿™ä¸ªå˜é‡`y = 2;` ã€‚ å› ä¸º`y = 2;` è¢«ä¿å­˜åœ¨ Environment Recordå½“å‰ç¯å¢ƒï¼Œè¿™ä¸ªå±æ€§ä¸­äº†ã€‚

### ä¸¾ä¾‹2ï¼š

![03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%207.png](03%20JS%E7%BB%93%E6%9E%84%E5%8C%96%E8%AE%BE%E8%AE%A1%2064288a5ad3224689b776443bb93ebd03/Untitled%207.png)

- åœ¨å·¦è¾¹ï¼Œå…ˆå®šä¹‰å˜é‡yï¼Œç„¶åæ‰§è¡Œfoo2å‡½æ•°ã€‚
    - foo2å‡½æ•°ä¸­ï¼šç¯å¢ƒéƒ¨åˆ†ï¼Œä¿å­˜äº†åœ¨å®šä¹‰æ—¶ï¼Œç¯å¢ƒä¸­å­˜åœ¨çš„å˜é‡yï¼›åŒæ—¶ä¿å­˜äº†å‡½æ•°å†…éƒ¨å®šä¹‰çš„å˜é‡zã€‚
- æœ€åï¼Œå®šä¹‰foo3ã€‚
    - foo3å‡½æ•°ä¸­ï¼šç¯å¢ƒéƒ¨åˆ†ï¼Œä¿å­˜äº†åœ¨å®šä¹‰æ—¶ï¼Œç¯å¢ƒå˜é‡ä¸­å­˜åœ¨çš„å˜é‡zï¼ˆæºäºfoo2ï¼‰ã€å˜é‡yï¼ˆæºäºåœ¨foo2ä¿å­˜çš„ç¯å¢ƒå˜é‡ï¼‰ã€thisï¼ˆæºäºfoo2ä¸­æ‰§è¡Œæ—¶çš„thisï¼‰ã€‚
- å½¢æˆäº†ä½œç”¨åŸŸé“¾ï¼šy â‡’ z â‡’ ...

## Realm

ES2018ä¸­çš„æ–°æ ‡å‡†ã€‚

åœ¨JSä¸­ï¼Œå‡½æ•°è¡¨è¾¾å¼å’Œå¯¹è±¡ç›´æ¥é‡å‡ä¼šåˆ›å»ºObjectå¯¹è±¡ã€‚ä½¿ç”¨ `.` åšéšå¼è½¬æ¢ä¹Ÿä¼šåˆ›å»ºObjectå¯¹è±¡ã€‚ä½†æ˜¯äº§ç”Ÿçš„è¿™äº›Objectå¯¹è±¡ä¹Ÿæ˜¯åº”è¯¥æœ‰åŸå‹çš„ã€‚

```jsx
var x = {}     // åˆ›å»ºäº†ä¸€ä¸ªObjectå¯¹è±¡ã€‚
1.toString();  // è‡ªåŠ¨è£…ç®±ï¼Œäº§ç”Ÿäº†ä¸€ä¸ªNumberå¯¹è±¡ã€‚
```

åœ¨ä¸åŒçš„ iframe ä¸­åˆ›å»ºå¯¹è±¡ï¼ŒåŸå‹ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œéœ€è¦è®°å½•ã€‚

Realmè§„å®šäº†ï¼Œåœ¨ä¸€ä¸ªå®ä¾‹å¯¹è±¡é‡Œï¼Œå®ƒæ‰€æœ‰çš„å†…ç½®å¯¹è±¡ä¼šè¢«æ”¾è¿›ä¸€ä¸ªRealmä¸­ã€‚

### ä½œä¸šï¼šå¯è§†åŒ–JSä¸­Realmä¸­çš„æ‰€æœ‰å¯¹è±¡ã€‚

```jsx
<div id="container" style="width: 200vw; height: 200vh"></div>
<script src="https://gw.alipayobjects.com/os/lib/antv/g6/3.7.1/dist/g6.min.js"></script>
<script>
	let set = new Set()
	let objects = [
		'eval',
		'isFinite',
		'isNaN',
		'parseFloat',
		'parseInt',
		'decodeURI',
		'decodeURIComponent',
		'encodeURI',
		'encodeURIComponent',
		'Array',
		'Date',
		'RegExp',
		'Promise',
		'Proxy',
		'Map',
		'WeakMap',
		'Set',
		'WeakSet',
		'Function',
		'Boolean',
		'String',
		'Number',
		'Symbol',
		'Object',
		'Error',
		'EvalError',
		'RangeError',
		'ReferenceError',
		'SyntaxError',
		'TypeError',
		'URIError',
		'ArrayBuffer',
		'SharedArrayBuffer',
		'DataView',
		'Float32Array',
		'Float64Array',
		'Int8Array',
		'Int16Array',
		'Int32Array',
		'Uint8Array',
		'Uint16Array',
		'Uint32Array',
		'Uint8ClampedArray',
		'Atomics',
		'JSON',
		'Math',
		'Reflect',
	]

	objects.forEach(o => set.add(o))

	const realm = {
		id: 'Realm',
		children: objects.map(o => ({
			id: o,
			children: [],
		})),
	}

	let queue = [...realm.children]

	while (queue.length > 0) {
		let child = queue.shift()
		let id = child.id
		let children = child.children

		for (let p of Object.getOwnPropertyNames(window[id])) {
			let d = Object.getOwnPropertyDescriptor(window[id], p)
			if (
				(d.value !== null && typeof d.value === 'object') ||
				typeof d.value === 'function'
			) {
				if (!set.has(d.value)) {
					set.add(d.value)
					children.push({
						id: `${id}.${p}`,
						children: [],
					})
				}
				if (d.get) {
					if (!set.has(d.get)) {
						set.add(d.get)
						children.push({
							id: `${id}.${p}.get`,
							children: [],
						})
					}
				}
				if (d.set) {
					if (!set.has(d.set)) {
						set.add(d.set)
						children.push({
							id: `${id}.${p}.set`,
							children: [],
						})
					}
				}
			}
		}
	}
</script>
<script>
	const width = document.getElementById('container').scrollWidth
	const height = document.getElementById('container').scrollHeight || 500

	const graph = new G6.TreeGraph({
		container: 'container',
		width,
		height,
		modes: {
			default: [
				{
					type: 'collapse-expand',
					onChange: function onChange(item, collapsed) {
						const data = item.get('model').data
						data.collapsed = collapsed
						return true
					},
				},
				'drag-canvas',
				'zoom-canvas',
			],
		},
		defaultNode: {
			size: 26,
			anchorPoints: [
				[0, 0.5],
				[1, 0.5],
			],
			style: {
				fill: '#C6E5FF',
				stroke: '#5B8FF9',
			},
		},
		defaultEdge: {
			type: 'cubic-horizontal',
			style: {
				stroke: '#A3B1BF',
			},
		},
		layout: {
			type: 'compactBox',
			direction: 'LR',
			getId: function getId(d) {
				return d.id
			},
			getHeight: function getHeight() {
				return 16
			},
			getWidth: function getWidth() {
				return 16
			},
			getVGap: function getVGap() {
				return 10
			},
			getHGap: function getHGap() {
				return 100
			},
		},
	})

	graph.node(function (node) {
		return {
			label: node.id,
			labelCfg: {
				offset: 10,
				position:
					node.children && node.children.length > 0
						? 'left'
						: 'right',
			},
		}
	})

	graph.data(realm)
	graph.render()
	graph.fitView()
</script>
```